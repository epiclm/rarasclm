<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layout/rarasClmLayout">
<head>
<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
var routeBase  = /*[[${route.baseUrl}]]*/'';
var contextApp = /*[[${baseModel.baseApp}]]*/'';
var enfermedades;
var enfermedadesLiterales;

function renderBotonesPaciente(num,deno) {
	var strShow = "<a class='btn btn-primary' style='margin-right:5px' href='"+routeBase+"show/"+num+"'>Ver</a>";
	var strEdit = "<a class='btn btn-success' style='margin-right:5px' href='"+routeBase+"edit/"+num+"'>Editar</a>";
	return "<p style='display:inline-block;margin-right:10px;font-weight:bold'>"+deno+"</p>"+strShow+strEdit;
}

$(document)
.ready(function() {	
	
		var isOKForm = false;
		var strHtml='<option value="99999" select>DESCONOCIDO</option>\n'
		
		$('#busquedaMunicipio').html(strHtml);
	
		$("#img-espera-num-paciente").css('display','none');
	
		$("#form-search-paciente").on('submit',function(e) {
			if(!isOkForm)
		    	e.preventDefault();
		  });
		
		
		$('.btn').on('click', function(){
			isOkForm=false;
		});
		
		$('#submitBuscarPacientes').on('click', function(){
			isOkForm=true;
		});
		
		
		$("#borrarFormulario").on('click', function() {
			$("#busquedaCIP,#busquedaApellido1,#busquedaApellido2,#busquedaNombre").val('');
			$("#busquedaFechaNacimiento").val('');
			$('#busquedaProvincia').val('99').change();
			$('#busquedaMuncipio').val('99999').change();
		});
		
		$("#busquedaProvincia").change(function() {
			var provincia = $(this).val();
			
			$('#busquedaMunicipio').html("<p>CARGANDO...</p>");
			$.ajax({
				url:'/'+ contextApp + '/localizaciones/municipios/deprovincia/'+provincia,
				dataType:'json',
			}).fail(function(jqXHR, textStatus, errorThrown)   {
		
			}).done(function(data, textStatus, jqXHR)   {
				for(i=0;i<data.length;i++) {
					strHtml += '<option value="' + data[i].municipio +'">'+ data[i].deno + '</option>\n'
				}
			}).always(function() {
				$('#busquedaMunicipio').html(strHtml);
			})
		});
	
		$("#busquedaCIP,#busquedaApellido1,#busquedaApellido2,#busquedaNombre")
			.focusout( 
				function() {
					$('#busquedaNumeroPaciente').val('');
					$("#resultado-busqueda-num-paciente").html("");
					$(this).val($(this).val().toUpperCase());
					if($(this).attr("id")==="busquedaCIP")
					{
						if($(this).val().length>0)
						{
							//alert("CIP: "+$(this).val())
						}
					}
			  	});
		
	   $("#btnBusquedaNumeroPaciente").on('click',function() {
		   var val = $("#busquedaNumeroPaciente").val();
		   $("#resultado-busqueda-num-paciente").html("");
		   $("#img-espera-num-paciente").css('display','inline-block');
		   
		   $.ajax({
			  url: routeBase + "show/json/" + val,
			  dataType: 'json',
			  type: 'GET'
		   }).done(function(data,textStatus,jqXHR) {
			   var deno = data.apellido01.toUpperCase()+" "+data.apellido02.toUpperCase()+", "+data.nombre.toUpperCase();
			   $("#resultado-busqueda-num-paciente").html(renderBotonesPaciente(val,deno));
		   }).fail(function(jqXHR, textStatus, errorThrown) {
			   $("#resultado-busqueda-num-paciente").html("<p class='text-error'>No se encuentra</p>");
		   }).always(function(dataJq,errorOrJqXHR) {
			   $("#img-espera-num-paciente").css('display','none'); 
		   });	   
	   });
	   
	   //Autocompletado de CIE10
		$.ajax({
			dataType : "json",
			url :   "/" + contextApp + "/enfermedades/cie10/json",
			contentType : "application/json; charset=utf-8" 
			 }).done( function(data) {
				enfermedades = data;
				enfermedadesLiterales = $.map(enfermedades,
						function(v) {
										return {
													label:v.cie10Id + ' ' + v.literal,
													value:v.cie10Id
												};
									});
				$("#autocompleteCie10").autocomplete({
					source : enfermedadesLiterales,
					search : function(event, ui) {

					},
					select : function(event, ui) {
						event.preventDefault();
						$("#autocompleteCie10").val(ui.item.label);
					},
					minLength : 3
				});
			});
	   
});
/*]]>*/
</script>
</head>
<body>
	<div id="contenido" layout:fragment="content">
	
		<div id="tabBusquedaIndex" class="tab-content row  span12">
		
			<ul class="nav nav-tabs">
				<li th:attr="class=${busqueda.pacientes==null ? 'active' : ''}">
					<a href="#tab-paciente-busqueda" data-toggle="tab">Búsquedas:</a>
				</li>
				<li th:attr="class=${busqueda.pacientes!=null ? 'active' : ''}">
					<a href="#tab-paciente-resultados" data-toggle="tab">Resultados</a>
				</li>
			</ul>
			
			
			<div class="tab-content">
			
				<!-- BUSQUEDAS -->
				<div id="tab-paciente-busqueda" th:attr="class=${busqueda.pacientes==null ? 'tab-pane fade in active' : 'tab-pane fade'}">
					<div class="row offset1">
						<form id="form-edit-paciente" class="form-edit-busqueda" method='POST'>
							<div class="row span10">
								<div id="grupo-apellido01-paciente" class="form-group">
									<label class="control-label span3" for="apellido01">1er Apellido:</label>
									<input id="apellido01" class="span3" name="apellido01" type="text" maxlength="65" th:value="${busqueda.apellido01}" placeholder="1er apellido"/>
								</div>
								<div id="grupo-apellido02-paciente" class="form-group ">	
									<label class="control-label span3" for="apellido02">2o Apellido:</label>
									<input id="apellido02" class="span3" name="apellido02" type="text" maxlength="65" th:value="${busqueda.apellido02}" placeholder="2o apellido"/>
								</div>
								<div id="grupo-nombre-paciente" class="form-group ">		
									<label class="control-label span3" for="nombre">Nombre:</label>
									<input id="nombre" class="span3" name="nombre" type="text" maxlength="65" th:value="${busqueda.nombre}" placeholder="nombre"/>
								</div>
							</div>
							<div class="row span10">
								<div  class="form-group">
									<label class="control-label span3" for="cip">CIP:</label>
									<input  class="span3" id="cip" name="cip" type="text" maxlength="16" th:value="${busqueda.cip}"/>
								</div>
							</div>
							<div class="row span10">
								<div class="form-group control-group">
									<label class="control-label span3" for="busquedaProvincia">Provincia Res.:</label>
									<select name="busquedaProvincia" class="span3" id="busquedaProvincia"  th:field="${busqueda.provincia}" >
										<option th:each="provincia : ${baseModel.cache.provinciasCLM}" th:value="${provincia.provincia}" th:text="${provincia.deno}"></option>
									</select>
								</div>
								<div class="form-group control-group">
									<label class="control-label span4" for="busquedaMunicipio">Muncipio Res.:</label>
									<select name="busquedaMunicipio" class="span4" id="busquedaMunicipio"  th:field="${busqueda.municipio}" >
										<option th:if="${municipiosProvinciaResidencia}!=null" th:each="m : ${municipiosProvinciaResidencia}" th:value="${m.municipio}" th:text="${m.deno}"></option>
									</select>
								</div>
							</div>
							<div class="row span10">
								<div class="form-group">
									<label class="control-label span2 " for="fechaNacimiento">Fecha Nacimiento:</label>
									<input name="fechaNacimiento" class="span2" id="fechaNacimiento" type="date"  th:value="${busqueda.fechaNacimiento!=null ? #dates.format(busqueda.fechaNacimiento, 'yyyy-MM-dd') : ''}" />
								</div>
								<div class="form-group">
									<label class="control-label span2 " for="sexo">Sexo:</label>
									<select name="sexo" class="span2" id="sexo"  th:field="${busqueda.sexo}" >
										<option value="1">VARÓN</option>
										<option value="6">MUJER</option>
										<option value="9">DESCONOCIDO</option>
									</select>
								</div>
							</div>
							<div id="busquedaPorEnfermedad" class="row span10">
								<input id ="enfermedadRaraCLM" name="enfermedadRaraCLM" type="hidden" th:value="${busqueda.enfermedadRaraCLM}"></input>
								<input id="cie9MC" name="cie9MC" type="hidden" th:value="${busqueda.cie9MC}"></input>
								<input id="cie10"  name="cie10"  type="hidden" th:value="${busqueda.cie10}"></input>
								<div class="form-group">
									<label class="control-label span6" for="autocompleteEnfermedadRaraCLM">Enfermedad RaraCLM:</label>
									<input class="span6" id="autocompleteEnfermedadRaraCLM" type="text"></input>
								</div>
								<div class="form-group">
									<label class="control-label span6" for="autocompleteEnfermedadRaraCLM">CIE9MC:</label>
									<input class="span6" id="autocompleteCie9MC" type="text"></input>
								</div>
								<div class="form-group">
									<label class="control-label span6" for="autocompleteEnfermedadRaraCLM">CIE10:</label>
									<input class="span6" id="autocompleteCie10" type="text"></input>
								</div>
							</div>
						</form>
				  	</div>
				</div><!-- Fin Tab Formuliario de Búsqueda -->

				<!-- PACIENTES -->
				<div id="tab-paciente-resultados" th:attr="class=${busqueda.pacientes!=null ? 'tab-pane fade in active' : 'tab-pane fade'}">
					<div class="">
							
					 </div>
					<!--<ul th:each="paciente: ${busqueda.pacientes}">
						<li><a th:href="|${route.baseUrl}edit/${paciente.idPaciente}|" th:text="|${paciente.idPaciente} ${paciente.apellido01} ${paciente.apellido02}, ${paciente.nombre} ${baseModel.cache.getMunipioDeno(paciente.municipioResidencia)} (${baseModel.cache.getProvinciaDeno(paciente.municipioResidencia.substring(0,2))})|"></a></li>
					</ul>-->
				</div>
				
			</div><!-- Fin de Tabs Content-->
		</div><!--  Fin div de Tabs -->
		
	</div><!-- Fin Contenido -->
</body>
</html>